<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片格式转换 - 在线转换JPG/PNG/WebP/GIF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        @layer utilities {
            .gradient-bg {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            }
            .drop-area {
                border: 2px dashed #cbd5e1;
                transition: all 0.3s ease;
            }
            .drop-area.active {
                border-color: #3b82f6;
                background-color: #eff6ff;
            }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <!-- 导航栏 -->
    <header class="gradient-bg text-white py-4 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-exchange text-xl"></i>
                <h1 class="text-xl font-bold">图片格式转换工具</h1>
            </div>
            <a href="index.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                返回工具列表
            </a>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">图片格式转换</h2>
            <p class="text-slate-600 mb-6">支持JPG、PNG、WebP、GIF格式互转，批量转换，保留原始质量</p>
            
            <!-- 上传区域 -->
            <div id="dropArea" class="drop-area rounded-lg p-8 text-center mb-6">
                <i class="fa fa-cloud-upload text-4xl text-slate-400 mb-3"></i>
                <p class="text-slate-600 mb-2">点击或拖拽图片到此处上传</p>
                <p class="text-sm text-slate-400">支持JPG、PNG、WebP、GIF格式，可批量上传，单张最大10MB</p>
                <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                <button onclick="document.getElementById('fileInput').click()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    选择图片
                </button>
            </div>

            <!-- 转换设置 -->
            <div id="convertSettings" class="hidden mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-bold mb-3 text-slate-700">输出设置</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-slate-600 mb-1">输出格式</label>
                                <select id="outputFormat" class="w-full border border-slate-300 rounded-lg p-2">
                                    <option value="jpg">JPG (质量可调)</option>
                                    <option value="png">PNG (无损)</option>
                                    <option value="webp">WebP (高压缩)</option>
                                    <option value="gif">GIF (动画)</option>
                                </select>
                            </div>
                            
                            <div id="qualityGroup">
                                <label class="block text-sm text-slate-600 mb-1">转换质量</label>
                                <input type="range" id="quality" min="0" max="100" value="90" class="w-full">
                                <div class="flex justify-between text-xs text-slate-500 mt-1">
                                    <span>低质量</span>
                                    <span id="qualityValue">90%</span>
                                    <span>高质量</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm text-slate-600 mb-1">文件名前缀</label>
                                <input type="text" id="filePrefix" placeholder="例如: converted_" class="w-full border border-slate-300 rounded-lg p-2">
                            </div>
                            
                            <div class="flex gap-3">
                                <button id="convertBtn" class="flex-1 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    开始转换
                                </button>
                                <button id="clearBtn" class="flex-1 bg-slate-600 text-white px-6 py-2 rounded-lg hover:bg-slate-700 transition-colors">
                                    清空列表
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-3 text-slate-700">文件列表</h3>
                        <div id="fileList" class="border border-slate-200 rounded-lg p-3 max-h-[300px] overflow-y-auto bg-slate-50">
                            <p class="text-slate-500 text-center py-4">暂无文件</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 转换结果 -->
            <div id="resultArea" class="hidden mb-6">
                <h3 class="font-bold mb-3 text-slate-700">转换结果</h3>
                <div id="resultList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>
                
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="downloadAllBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fa fa-download mr-2"></i>下载全部
                    </button>
                    <button id="convertAnotherBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        转换其他图片
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-slate-800 text-white py-4 text-center text-sm">
        <p>© 2025 在线工具集 - 所有操作均在本地完成，不会上传您的图片</p>
    </footer>

    <script>
        // DOM元素
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const convertSettings = document.getElementById('convertSettings');
        const outputFormat = document.getElementById('outputFormat');
        const qualityGroup = document.getElementById('qualityGroup');
        const quality = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const filePrefix = document.getElementById('filePrefix');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const fileList = document.getElementById('fileList');
        const resultArea = document.getElementById('resultArea');
        const resultList = document.getElementById('resultList');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const convertAnotherBtn = document.getElementById('convertAnotherBtn');
        
        // 全局变量
        let files = [];
        let convertedBlobs = [];

        // 初始化
        quality.addEventListener('input', () => {
            qualityValue.textContent = `${quality.value}%`;
        });
        
        // 输出格式切换
        outputFormat.addEventListener('change', () => {
            // 只有JPG和WebP支持质量调整
            const format = outputFormat.value;
            qualityGroup.style.display = (format === 'jpg' || format === 'webp') ? 'block' : 'none';
        });

        // 拖拽功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('active');
        }

        function unhighlight() {
            dropArea.classList.remove('active');
        }

        // 处理文件上传
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const droppedFiles = dt.files;
            handleFileList(droppedFiles);
        }

        function handleFiles() {
            handleFileList(this.files);
        }

        function handleFileList(fileList) {
            // 过滤图片文件
            const imageFiles = Array.from(fileList).filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length > 0) {
                files = [...files, ...imageFiles];
                updateFileList();
                convertSettings.classList.remove('hidden');
                resultArea.classList.add('hidden');
            }
        }

        // 更新文件列表
        function updateFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '<p class="text-slate-500 text-center py-4">暂无文件</p>';
                convertSettings.classList.add('hidden');
                return;
            }
            
            fileList.innerHTML = '';
            files.forEach((file, index) => {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileType = file.type.split('/')[1].toUpperCase();
                
                const fileItem = document.createElement('div');
                fileItem.className = 'flex justify-between items-center py-2 border-b border-slate-200 last:border-0';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-file-image-o text-blue-500 mr-2"></i>
                        <div>
                            <p class="font-medium">${file.name}</p>
                            <p class="text-xs text-slate-500">${fileSize} MB · ${fileType}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        // 移除文件
        window.removeFile = function(index) {
            files.splice(index, 1);
            updateFileList();
        };

        // 清空列表
        clearBtn.addEventListener('click', () => {
            files = [];
            convertedBlobs = [];
            updateFileList();
            resultArea.classList.add('hidden');
        });

        // 转换图片
        convertBtn.addEventListener('click', async () => {
            if (files.length === 0) return;
            
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>转换中...';
            
            convertedBlobs = [];
            resultList.innerHTML = '';
            
            // 逐个转换图片
            for (let i = 0; i < files.length; i++) {
                await convertImage(files[i], i);
            }
            
            convertBtn.disabled = false;
            convertBtn.innerHTML = '开始转换';
            convertSettings.classList.add('hidden');
            resultArea.classList.remove('hidden');
        });

        // 转换单个图片
        function convertImage(file, index) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        // 创建canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // 绘制图片
                        ctx.drawImage(img, 0, 0);
                        
                        // 获取输出格式和质量
                        const format = outputFormat.value;
                        const qualityVal = quality.value / 100;
                        
                        // 转换格式
                        let mimeType = `image/${format}`;
                        if (format === 'jpg') mimeType = 'image/jpeg';
                        
                        // 转换为Blob
                        canvas.toBlob((blob) => {
                            convertedBlobs.push({
                                blob: blob,
                                originalFile: file,
                                format: format
                            });
                            
                            // 创建预览项
                            createResultItem(blob, file, index, format);
                            resolve();
                        }, mimeType, qualityVal);
                    };
                };
                
                reader.readAsDataURL(file);
            });
        }

        // 创建结果项
        function createResultItem(blob, file, index, format) {
            const url = URL.createObjectURL(blob);
            const fileSize = (blob.size / 1024 / 1024).toFixed(2);
            
            // 获取文件名
            const prefix = filePrefix.value || '';
            const fileName = prefix + file.name.replace(/\.\w+$/, `.${format}`);
            
            const resultItem = document.createElement('div');
            resultItem.className = 'border border-slate-200 rounded-lg overflow-hidden bg-slate-50';
            resultItem.innerHTML = `
                <div class="relative aspect-video overflow-hidden">
                    <img src="${url}" class="w-full h-full object-contain">
                </div>
                <div class="p-3">
                    <p class="font-medium text-sm truncate">${fileName}</p>
                    <p class="text-xs text-slate-500 mb-3">${fileSize} MB · ${format.toUpperCase()}</p>
                    <button onclick="downloadFile(${index})" class="w-full bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 transition-colors text-sm">
                        <i class="fa fa-download mr-1"></i>下载
                    </button>
                </div>
            `;
            
            resultList.appendChild(resultItem);
        }

        // 下载单个文件
        window.downloadFile = function(index) {
            const item = convertedBlobs[index];
            if (!item) return;
            
            const prefix = filePrefix.value || '';
            const fileName = prefix + item.originalFile.name.replace(/\.\w+$/, `.${item.format}`);
            
            const url = URL.createObjectURL(item.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // 下载全部文件
        downloadAllBtn.addEventListener('click', () => {
            if (convertedBlobs.length === 1) {
                downloadFile(0);
            } else if (convertedBlobs.length > 1) {
                // 提示批量下载需要Zip库
                alert('批量下载需要引入JSZip库，已开始逐个下载文件');
                convertedBlobs.forEach((_, index) => downloadFile(index));
            }
        });

        // 转换其他图片
        convertAnotherBtn.addEventListener('click', () => {
            resultArea.classList.add('hidden');
            convertSettings.classList.remove('hidden');
            fileInput.value = ''; // 清空文件选择
        });
    </script>
</body>
</html>