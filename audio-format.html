<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>音频格式转换工具</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; }
        .upload-area:hover { border-color: #10b981; }
        #fileInput { display: none; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #059669; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        select, input { padding: 8px; margin: 0 10px; }
        .file-list { margin: 20px 0; padding: 10px; border: 1px solid #eee; }
        .file-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .progress { height: 10px; background: #eee; margin: 20px 0; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h2>音频格式转换工具</h2>
        
        <!-- 上传区域 -->
        <div class="upload-area" id="uploadArea">
            点击或拖拽上传音频文件
            <input type="file" id="fileInput" accept="audio/*, .mp3, .wav, .ogg, .flac, .aac, .m4a" multiple style="display: none;">
        </div>
        
        <!-- 转换配置 -->
        <div class="controls">
            <label>目标格式：</label>
            <select id="targetFormat">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="ogg">OGG</option>
                <option value="flac">FLAC</option>
            </select>
            
            <label>文件大小限制：</label>
            <span>最大50MB</span>
            
            <button id="convertBtn" disabled>开始转换</button>
        </div>
        
        <!-- 文件列表 -->
        <div class="file-list" id="fileList">
            暂无文件，请先上传
        </div>
        
        <!-- 进度条 -->
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <!-- 引入ffmpeg.wasm（前端音频转换核心库） -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
    <script>
        // DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const targetFormat = document.getElementById('targetFormat');
        const convertBtn = document.getElementById('convertBtn');
        const fileList = document.getElementById('fileList');
        const progressBar = document.getElementById('progressBar');
        
        // 全局变量
        let audioFiles = []; // 存储合法的音频文件
        const MAX_SIZE = 50 * 1024 * 1024; // 50MB
        
        // 初始化ffmpeg
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js'
        });

        // 1. 修复文件添加问题：上传逻辑
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#10b981';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // 2. 处理文件选择（核心：宽松校验，避免拦截合法文件）
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        }

        // 3. 批量处理文件
        function handleFiles(files) {
            audioFiles = []; // 清空旧文件
            const validFiles = [];
            
            // 遍历文件，宽松校验
            Array.from(files).forEach(file => {
                // 校验1：文件大小
                if (file.size > MAX_SIZE) {
                    alert(`文件 ${file.name} 超过50MB，无法上传`);
                    return;
                }
                
                // 校验2：文件格式（宽松判断，兼容大小写/无后缀）
                if (isValidAudio(file)) {
                    validFiles.push(file);
                    audioFiles.push(file);
                } else {
                    alert(`文件 ${file.name} 不是合法的音频文件`);
                }
            });
            
            // 更新文件列表
            renderFileList(validFiles);
            
            // 启用转换按钮
            convertBtn.disabled = validFiles.length === 0;
        }

        // 4. 宽松的音频格式校验（解决格式拦截问题）
        function isValidAudio(file) {
            // 支持的后缀（忽略大小写）
            const validExts = ['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a', 'wma', 'ape'];
            // 支持的MIME类型
            const validTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/flac', 'audio/aac', 'audio/mp4'];
            
            // 取文件后缀（兼容大写）
            const ext = file.name.split('.').pop()?.toLowerCase() || '';
            
            // 宽松判断：后缀合法 或 MIME类型合法 或 类型包含audio
            return validExts.includes(ext) || validTypes.includes(file.type) || file.type.startsWith('audio/');
        }

        // 5. 渲染文件列表
        function renderFileList(files) {
            if (files.length === 0) {
                fileList.innerHTML = '暂无文件，请先上传';
                return;
            }
            
            let html = '';
            files.forEach((file, index) => {
                html += `
                    <div class="file-item">
                        <span>${index + 1}. ${file.name} (${formatFileSize(file.size)})</span>
                        <span>格式：${getFileExt(file.name)}</span>
                    </div>
                `;
            });
            fileList.innerHTML = html;
        }

        // 辅助：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // 辅助：获取文件后缀
        function getFileExt(filename) {
            return filename.split('.').pop()?.toLowerCase() || '未知';
        }

        // 6. 转换音频核心逻辑
        convertBtn.addEventListener('click', async () => {
            if (audioFiles.length === 0) return;
            
            // 禁用按钮
            convertBtn.disabled = true;
            progressBar.style.width = '0%';
            
            try {
                // 加载ffmpeg
                progressBar.style.width = '10%';
                if (!ffmpeg.isLoaded()) {
                    await ffmpeg.load();
                }
                
                // 遍历转换每个文件
                for (let i = 0; i < audioFiles.length; i++) {
                    const file = audioFiles[i];
                    const fileName = file.name;
                    const fileExt = getFileExt(fileName);
                    const newFileName = fileName.replace(`.${fileExt}`, `.${targetFormat.value}`);
                    
                    // 更新进度
                    progressBar.style.width = `${10 + (i / audioFiles.length) * 80}%`;
                    
                    // 写入文件到ffmpeg
                    ffmpeg.FS('writeFile', fileName, await fetchFile(file));
                    
                    // 执行转换
                    await ffmpeg.run('-i', fileName, newFileName);
                    
                    // 读取转换后的文件
                    const data = ffmpeg.FS('readFile', newFileName);
                    
                    // 下载文件
                    const url = URL.createObjectURL(new Blob([data.buffer], { type: `audio/${targetFormat.value}` }));
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = newFileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // 清理
                    URL.revokeObjectURL(url);
                    ffmpeg.FS('unlink', fileName);
                    ffmpeg.FS('unlink', newFileName);
                }
                
                // 完成
                progressBar.style.width = '100%';
                alert('所有文件转换完成！');
                
            } catch (e) {
                alert('转换失败：' + e.message);
            } finally {
                // 恢复按钮
                progressBar.style.width = '0%';
                convertBtn.disabled = false;
            }
        });
    </script>
</body>
</html>